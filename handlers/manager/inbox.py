"""
Manager Inbox Module - Complete Inline Keyboard Implementation
Author: Telegram Bot Development Team
Date: 2024
"""

from aiogram import Router, F
from aiogram.types import Message, CallbackQuery, InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.filters import Command, StateFilter
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from typing import Optional, List, Dict, Any
from datetime import datetime, timedelta
import logging
import asyncio

logger = logging.getLogger(__name__)

# ================== MOCK DATA ==================
MOCK_INBOX_DATA = {
    "messages": [
        {
            "id": "12345",
            "from": "Alisher Karimov",
            "phone": "+998901234567",
            "subject": "Ulanish arizasi",
            "message": "Internet ulash kerak. Manzil: Toshkent, Chorsu, 100 Mbps tarif",
            "priority": "urgent",
            "status": "new",
            "time": datetime.now() - timedelta(hours=2),
            "type": "connection",
            "address": "Toshkent, Chorsu",
            "tariff": "100 Mbps - 89,000 UZS"
        },
        {
            "id": "12344",
            "from": "Malika Azizova",
            "phone": "+998901234568",
            "subject": "Texnik xizmat",
            "message": "Internet sekin ishlayapti, tekshirish kerak",
            "priority": "medium",
            "status": "pending",
            "time": datetime.now() - timedelta(hours=1),
            "type": "technical",
            "address": "Toshkent, Yunusabad",
            "tariff": "200 Mbps - 149,000 UZS"
        },
        {
            "id": "12343",
            "from": "Jamshid Rahimov",
            "phone": "+998901234569",
            "subject": "Tarif o'zgartirish",
            "message": "100 Mbps dan 200 Mbps ga o'tkazish",
            "priority": "low",
            "status": "resolved",
            "time": datetime.now() - timedelta(minutes=30),
            "type": "change",
            "address": "Toshkent, Sergeli",
            "tariff": "500 Mbps - 299,000 UZS"
        },
        {
            "id": "12342",
            "from": "Dilnoza Saidova",
            "phone": "+998901234570",
            "subject": "Yangi ulanish",
            "message": "Ofisga internet kerak, 1 Gbps tarif",
            "priority": "high",
            "status": "new",
            "time": datetime.now() - timedelta(minutes=15),
            "type": "connection",
            "address": "Toshkent, Mirzo Ulug'bek",
            "tariff": "1 Gbps - 499,000 UZS"
        },
        {
            "id": "12341",
            "from": "Rustam Xolmatov",
            "phone": "+998901234571",
            "subject": "To'lov muammosi",
            "message": "To'lov o'tmadi, yordam kerak",
            "priority": "urgent",
            "status": "in_progress",
            "time": datetime.now() - timedelta(minutes=5),
            "type": "payment",
            "address": "Toshkent, Chilonzor",
            "tariff": "100 Mbps - 89,000 UZS"
        }
    ],
    "statistics": {
        "total": 45,
        "unread": 12,
        "urgent": 3,
        "pending": 7,
        "resolved": 25,
        "in_progress": 8
    },
    "junior_managers": [
        {"id": 11, "name": "Ahmad Toshmatov", "active_tasks": 3},
        {"id": 12, "name": "Malika Karimova", "active_tasks": 2},
        {"id": 13, "name": "Jasur Rahimov", "active_tasks": 5},
        {"id": 14, "name": "Dilfuza Abdullayeva", "active_tasks": 1}
    ]
}

# ================== STATES ==================
class ManagerInboxStates(StatesGroup):
    inbox_menu = State()
    viewing_messages = State()
    viewing_message_detail = State()
    replying_message = State()
    filtering = State()
    assigning_junior = State()
    searching = State()

# ================== KEYBOARDS ==================
def get_inbox_menu_keyboard(lang: str = "uz") -> InlineKeyboardMarkup:
    """Get inbox menu keyboard"""
    stats = MOCK_INBOX_DATA["statistics"]
    
    if lang == "uz":
        buttons = [
            [
                InlineKeyboardButton(
                    text=f"üìã Hammasi ({stats['total']})", 
                    callback_data="inbox:all"
                ),
                InlineKeyboardButton(
                    text=f"üÜï Yangi ({stats['unread']})", 
                    callback_data="inbox:new"
                )
            ],
            [
                InlineKeyboardButton(
                    text=f"üî¥ Shoshilinch ({stats['urgent']})", 
                    callback_data="inbox:urgent"
                ),
                InlineKeyboardButton(
                    text=f"‚è≥ Kutilmoqda ({stats['pending']})", 
                    callback_data="inbox:pending"
                )
            ],
            [
                InlineKeyboardButton(
                    text=f"üîÑ Jarayonda ({stats['in_progress']})", 
                    callback_data="inbox:in_progress"
                ),
                InlineKeyboardButton(
                    text=f"‚úÖ Hal qilingan ({stats['resolved']})", 
                    callback_data="inbox:resolved"
                )
            ],
            [
                InlineKeyboardButton(
                    text="üîç Qidirish", 
                    callback_data="inbox:search"
                ),
                InlineKeyboardButton(
                    text="üìä Statistika", 
                    callback_data="inbox:stats"
                )
            ],
            [
                InlineKeyboardButton(
                    text="‚¨ÖÔ∏è Orqaga", 
                    callback_data="manager:back_to_menu"
                )
            ]
        ]
    else:  # ru
        buttons = [
            [
                InlineKeyboardButton(
                    text=f"üìã –í—Å–µ ({stats['total']})", 
                    callback_data="inbox:all"
                ),
                InlineKeyboardButton(
                    text=f"üÜï –ù–æ–≤—ã–µ ({stats['unread']})", 
                    callback_data="inbox:new"
                )
            ],
            [
                InlineKeyboardButton(
                    text=f"üî¥ –°—Ä–æ—á–Ω—ã–µ ({stats['urgent']})", 
                    callback_data="inbox:urgent"
                ),
                InlineKeyboardButton(
                    text=f"‚è≥ –í –æ–∂–∏–¥–∞–Ω–∏–∏ ({stats['pending']})", 
                    callback_data="inbox:pending"
                )
            ],
            [
                InlineKeyboardButton(
                    text=f"üîÑ –í –ø—Ä–æ—Ü–µ—Å—Å–µ ({stats['in_progress']})", 
                    callback_data="inbox:in_progress"
                ),
                InlineKeyboardButton(
                    text=f"‚úÖ –†–µ—à–µ–Ω–Ω—ã–µ ({stats['resolved']})", 
                    callback_data="inbox:resolved"
                )
            ],
            [
                InlineKeyboardButton(
                    text="üîç –ü–æ–∏—Å–∫", 
                    callback_data="inbox:search"
                ),
                InlineKeyboardButton(
                    text="üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", 
                    callback_data="inbox:stats"
                )
            ],
            [
                InlineKeyboardButton(
                    text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", 
                    callback_data="manager:back_to_menu"
                )
            ]
        ]
    
    return InlineKeyboardMarkup(inline_keyboard=buttons)

def get_message_navigation_keyboard(current_index: int, total: int, message_id: str, lang: str = "uz") -> InlineKeyboardMarkup:
    """Get message navigation keyboard with junior manager assignment"""
    
    buttons = []
    
    # Navigation row
    nav_row = []
    if current_index > 0:
        nav_row.append(InlineKeyboardButton(
            text="‚¨ÖÔ∏è Oldingi" if lang == "uz" else "‚¨ÖÔ∏è –ü—Ä–µ–¥—ã–¥—É—â–∏–π",
            callback_data=f"inbox:prev:{current_index}"
        ))
    
    nav_row.append(InlineKeyboardButton(
        text=f"{current_index + 1}/{total}",
        callback_data="inbox:page_info"
    ))
    
    if current_index < total - 1:
        nav_row.append(InlineKeyboardButton(
            text="Keyingi ‚û°Ô∏è" if lang == "uz" else "–°–ª–µ–¥—É—é—â–∏–π ‚û°Ô∏è",
            callback_data=f"inbox:next:{current_index}"
        ))
    
    if nav_row:
        buttons.append(nav_row)
    
    # Action buttons
    if lang == "uz":
        buttons.extend([
            [
                InlineKeyboardButton(
                    text="üë®‚Äçüíº Kichik menejerga yuborish",
                    callback_data=f"inbox:assign_junior:{message_id}"
                )
            ],
            [
                InlineKeyboardButton(
                    text="üí¨ Javob berish",
                    callback_data=f"inbox:reply:{message_id}"
                ),
                InlineKeyboardButton(
                    text="‚úÖ Hal qilindi",
                    callback_data=f"inbox:resolve:{message_id}"
                )
            ],
            [
                InlineKeyboardButton(
                    text="üìä Batafsil",
                    callback_data=f"inbox:detail:{message_id}"
                ),
                InlineKeyboardButton(
                    text="üîÑ Status",
                    callback_data=f"inbox:status:{message_id}"
                )
            ],
            [
                InlineKeyboardButton(
                    text="‚¨ÖÔ∏è Orqaga",
                    callback_data="inbox:back_to_list"
                )
            ]
        ])
    else:
        buttons.extend([
            [
                InlineKeyboardButton(
                    text="üë®‚Äçüíº –û—Ç–ø—Ä–∞–≤–∏—Ç—å –º–ª–∞–¥—à–µ–º—É –º–µ–Ω–µ–¥–∂–µ—Ä—É",
                    callback_data=f"inbox:assign_junior:{message_id}"
                )
            ],
            [
                InlineKeyboardButton(
                    text="üí¨ –û—Ç–≤–µ—Ç–∏—Ç—å",
                    callback_data=f"inbox:reply:{message_id}"
                ),
                InlineKeyboardButton(
                    text="‚úÖ –†–µ—à–µ–Ω–æ",
                    callback_data=f"inbox:resolve:{message_id}"
                )
            ],
            [
                InlineKeyboardButton(
                    text="üìä –ü–æ–¥—Ä–æ–±–Ω–µ–µ",
                    callback_data=f"inbox:detail:{message_id}"
                ),
                InlineKeyboardButton(
                    text="üîÑ –°—Ç–∞—Ç—É—Å",
                    callback_data=f"inbox:status:{message_id}"
                )
            ],
            [
                InlineKeyboardButton(
                    text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥",
                    callback_data="inbox:back_to_list"
                )
            ]
        ])
    
    return InlineKeyboardMarkup(inline_keyboard=buttons)

def get_junior_managers_keyboard(message_id: str, lang: str = "uz") -> InlineKeyboardMarkup:
    """Get junior managers selection keyboard"""
    
    buttons = []
    
    for jm in MOCK_INBOX_DATA["junior_managers"]:
        text = f"üë§ {jm['name']} (Faol: {jm['active_tasks']})" if lang == "uz" else f"üë§ {jm['name']} (–ê–∫—Ç–∏–≤–Ω—ã—Ö: {jm['active_tasks']})"
        buttons.append([
            InlineKeyboardButton(
                text=text,
                callback_data=f"inbox:confirm_junior:{message_id}:{jm['id']}"
            )
        ])
    
    buttons.append([
        InlineKeyboardButton(
            text="‚ùå Bekor qilish" if lang == "uz" else "‚ùå –û—Ç–º–µ–Ω–∞",
            callback_data=f"inbox:cancel_junior:{message_id}"
        )
    ])
    
    return InlineKeyboardMarkup(inline_keyboard=buttons)

def format_time_ago(dt: datetime, lang: str = "uz") -> str:
    """Format time ago string"""
    now = datetime.now()
    diff = now - dt
    
    if lang == "uz":
        if diff.days > 0:
            return f"{diff.days} kun oldin"
        elif diff.seconds > 3600:
            return f"{diff.seconds // 3600} soat oldin"
        elif diff.seconds > 60:
            return f"{diff.seconds // 60} daqiqa oldin"
        else:
            return "hozirgina"
    else:  # ru
        if diff.days > 0:
            return f"{diff.days} –¥–Ω–µ–π –Ω–∞–∑–∞–¥"
        elif diff.seconds > 3600:
            return f"{diff.seconds // 3600} —á–∞—Å–æ–≤ –Ω–∞–∑–∞–¥"
        elif diff.seconds > 60:
            return f"{diff.seconds // 60} –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥"
        else:
            return "—Ç–æ–ª—å–∫–æ —á—Ç–æ"

def get_priority_emoji(priority: str) -> str:
    """Get priority emoji"""
    return {
        "urgent": "üî¥",
        "high": "üü†",
        "medium": "üü°",
        "low": "üü¢"
    }.get(priority, "‚ö™")

def get_status_emoji(status: str) -> str:
    """Get status emoji"""
    return {
        "new": "üÜï",
        "pending": "‚è≥",
        "in_progress": "üîÑ",
        "resolved": "‚úÖ",
        "closed": "üîí"
    }.get(status, "‚ùì")

# ================== HANDLERS ==================
async def show_inbox_menu(callback: CallbackQuery, state: FSMContext):
    """Show inbox menu"""
    
    data = await state.get_data()
    lang = data.get("language", "uz")
    stats = MOCK_INBOX_DATA["statistics"]
    
    if lang == "uz":
        text = f"""
üì• <b>KELGAN XABARLAR</b>

üìä <b>Statistika:</b>
‚îú üì¨ Jami xabarlar: {stats['total']}
‚îú üÜï Yangi: {stats['unread']}
‚îú üî¥ Shoshilinch: {stats['urgent']}
‚îú ‚è≥ Kutilmoqda: {stats['pending']}
‚îú üîÑ Jarayonda: {stats['in_progress']}
‚îî ‚úÖ Hal qilingan: {stats['resolved']}

<b>Qaysi xabarlarni ko'rmoqchisiz?</b>
        """
    else:
        text = f"""
üì• <b>–í–•–û–î–Ø–©–ò–ï –°–û–û–ë–©–ï–ù–ò–Ø</b>

üìä <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</b>
‚îú üì¨ –í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π: {stats['total']}
‚îú üÜï –ù–æ–≤—ã–µ: {stats['unread']}
‚îú üî¥ –°—Ä–æ—á–Ω—ã–µ: {stats['urgent']}
‚îú ‚è≥ –í –æ–∂–∏–¥–∞–Ω–∏–∏: {stats['pending']}
‚îú üîÑ –í –ø—Ä–æ—Ü–µ—Å—Å–µ: {stats['in_progress']}
‚îî ‚úÖ –†–µ—à–µ–Ω–Ω—ã–µ: {stats['resolved']}

<b>–ö–∞–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–∫–∞–∑–∞—Ç—å?</b>
        """
    
    await callback.message.edit_text(
        text,
        reply_markup=get_inbox_menu_keyboard(lang),
        parse_mode="HTML"
    )
    
    await state.set_state(ManagerInboxStates.inbox_menu)

def get_manager_inbox_router_min() -> Router:
    """Get complete manager inbox router with inline keyboards"""
    router = Router()
    
    @router.callback_query(F.data.startswith("inbox:"))
    async def handle_inbox_callbacks(callback: CallbackQuery, state: FSMContext):
        """Handle all inbox callbacks"""
        
        data = await state.get_data()
        lang = data.get("language", "uz")
        action_parts = callback.data.split(":")
        action = action_parts[1]
        
        # Handle different actions
        if action == "all":
            await show_messages_list(callback, state, filter_type="all")
        elif action == "new":
            await show_messages_list(callback, state, filter_type="new")
        elif action == "urgent":
            await show_messages_list(callback, state, filter_type="urgent")
        elif action == "pending":
            await show_messages_list(callback, state, filter_type="pending")
        elif action == "in_progress":
            await show_messages_list(callback, state, filter_type="in_progress")
        elif action == "resolved":
            await show_messages_list(callback, state, filter_type="resolved")
        elif action == "search":
            await show_search_menu(callback, state)
        elif action == "stats":
            await show_inbox_statistics(callback, state)
        elif action == "back_to_list":
            await show_inbox_menu(callback, state)
        elif action == "prev":
            current_index = int(action_parts[2])
            await navigate_message(callback, state, current_index - 1)
        elif action == "next":
            current_index = int(action_parts[2])
            await navigate_message(callback, state, current_index + 1)
        elif action == "assign_junior":
            message_id = action_parts[2]
            await show_junior_managers_list(callback, state, message_id)
        elif action == "confirm_junior":
            message_id = action_parts[2]
            junior_id = action_parts[3]
            await assign_to_junior_manager(callback, state, message_id, junior_id)
        elif action == "cancel_junior":
            message_id = action_parts[2]
            await cancel_junior_assignment(callback, state, message_id)
        elif action == "reply":
            message_id = action_parts[2]
            await start_reply_process(callback, state, message_id)
        elif action == "resolve":
            message_id = action_parts[2]
            await resolve_message(callback, state, message_id)
        elif action == "detail":
            message_id = action_parts[2]
            await show_message_detail(callback, state, message_id)
        elif action == "status":
            message_id = action_parts[2]
            await change_message_status(callback, state, message_id)
        elif action == "page_info":
            await callback.answer()
            return
        
        if action != "page_info":
            await callback.answer()
    
    async def show_messages_list(callback: CallbackQuery, state: FSMContext, filter_type: str = "all"):
        """Show filtered messages list"""
        
        data = await state.get_data()
        lang = data.get("language", "uz")
        
        # Filter messages based on type
        messages = MOCK_INBOX_DATA["messages"]
        if filter_type == "new":
            messages = [m for m in messages if m["status"] == "new"]
        elif filter_type == "urgent":
            messages = [m for m in messages if m["priority"] == "urgent"]
        elif filter_type == "pending":
            messages = [m for m in messages if m["status"] == "pending"]
        elif filter_type == "in_progress":
            messages = [m for m in messages if m["status"] == "in_progress"]
        elif filter_type == "resolved":
            messages = [m for m in messages if m["status"] == "resolved"]
        
        if not messages:
            text = "Xabarlar topilmadi" if lang == "uz" else "–°–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
            await callback.message.edit_text(
                f"‚ùå <b>{text}</b>",
                reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                    [InlineKeyboardButton(
                        text="‚¨ÖÔ∏è Orqaga" if lang == "uz" else "‚¨ÖÔ∏è –ù–∞–∑–∞–¥",
                        callback_data="inbox:back_to_list"
                    )]
                ]),
                parse_mode="HTML"
            )
            return
        
        # Show first message
        await state.update_data(current_messages=messages, current_index=0)
        await navigate_message(callback, state, 0)
    
    async def navigate_message(callback: CallbackQuery, state: FSMContext, index: int):
        """Navigate through messages"""
        
        data = await state.get_data()
        lang = data.get("language", "uz")
        messages = data.get("current_messages", MOCK_INBOX_DATA["messages"])
        
        if index < 0 or index >= len(messages):
            await callback.answer("Xabar mavjud emas" if lang == "uz" else "–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
            return
        
        message = messages[index]
        
        # Format message display
        if lang == "uz":
            text = f"""
üìß <b>ARIZA #{message['id']}</b>

üÜî ID: #{message['id']}
üí∞ Tarif: {message['tariff']}
üë§ Mijoz: {message['from']}
üì± Telefon: {message['phone']}
üìç Manzil: {message['address']}
‚è∞ Yaratilgan: {format_time_ago(message['time'], lang)}

{get_priority_emoji(message['priority'])} Muhimlik: {message['priority']}
{get_status_emoji(message['status'])} Status: {message['status']}

üìù <b>Xabar:</b>
{message['message']}
            """
        else:
            text = f"""
üìß <b>–ó–ê–Ø–í–ö–ê #{message['id']}</b>

üÜî ID: #{message['id']}
üí∞ –¢–∞—Ä–∏—Ñ: {message['tariff']}
üë§ –ö–ª–∏–µ–Ω—Ç: {message['from']}
üì± –¢–µ–ª–µ—Ñ–æ–Ω: {message['phone']}
üìç –ê–¥—Ä–µ—Å: {message['address']}
‚è∞ –°–æ–∑–¥–∞–Ω–æ: {format_time_ago(message['time'], lang)}

{get_priority_emoji(message['priority'])} –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: {message['priority']}
{get_status_emoji(message['status'])} –°—Ç–∞—Ç—É—Å: {message['status']}

üìù <b>–°–æ–æ–±—â–µ–Ω–∏–µ:</b>
{message['message']}
            """
        
        keyboard = get_message_navigation_keyboard(index, len(messages), message['id'], lang)
        
        await callback.message.edit_text(
            text,
            reply_markup=keyboard,
            parse_mode="HTML"
        )
        
        await state.update_data(current_index=index)
    
    async def show_junior_managers_list(callback: CallbackQuery, state: FSMContext, message_id: str):
        """Show junior managers list for assignment"""
        
        data = await state.get_data()
        lang = data.get("language", "uz")
        
        if lang == "uz":
            text = f"""
üë®‚Äçüíº <b>KICHIK MENEJER TANLASH</b>

Ariza #{message_id} uchun kichik menejerni tanlang:

üìä Faol vazifalar soni ko'rsatilgan
            """
        else:
            text = f"""
üë®‚Äçüíº <b>–í–´–ë–û–† –ú–õ–ê–î–®–ï–ì–û –ú–ï–ù–ï–î–ñ–ï–†–ê</b>

–í—ã–±–µ—Ä–∏—Ç–µ –º–ª–∞–¥—à–µ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –¥–ª—è –∑–∞—è–≤–∫–∏ #{message_id}:

üìä –ü–æ–∫–∞–∑–∞–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á
            """
        
        keyboard = get_junior_managers_keyboard(message_id, lang)
        
        await callback.message.edit_text(
            text,
            reply_markup=keyboard,
            parse_mode="HTML"
        )
        
        await state.set_state(ManagerInboxStates.assigning_junior)
    
    async def assign_to_junior_manager(callback: CallbackQuery, state: FSMContext, message_id: str, junior_id: str):
        """Assign message to junior manager"""
        
        data = await state.get_data()
        lang = data.get("language", "uz")
        
        # Find junior manager name
        junior_name = None
        for jm in MOCK_INBOX_DATA["junior_managers"]:
            if str(jm['id']) == junior_id:
                junior_name = jm['name']
                jm['active_tasks'] += 1
                break
        
        if lang == "uz":
            text = f"""
‚úÖ <b>MUVAFFAQIYATLI YUBORILDI!</b>

Ariza #{message_id}
Kichik menejerga yuborildi: {junior_name}
Vaqt: {datetime.now().strftime('%H:%M')}

Keyingi arizaga o'tish...
            """
        else:
            text = f"""
‚úÖ <b>–£–°–ü–ï–®–ù–û –û–¢–ü–†–ê–í–õ–ï–ù–û!</b>

–ó–∞—è–≤–∫–∞ #{message_id}
–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –º–ª–∞–¥—à–µ–º—É –º–µ–Ω–µ–¥–∂–µ—Ä—É: {junior_name}
–í—Ä–µ–º—è: {datetime.now().strftime('%H:%M')}

–ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–π –∑–∞—è–≤–∫–µ...
            """
        
        await callback.message.edit_text(
            text,
            parse_mode="HTML"
        )
        
        # Auto-navigate to next message after 2 seconds
        await asyncio.sleep(2)
        
        # Navigate to next message
        current_index = data.get("current_index", 0)
        messages = data.get("current_messages", MOCK_INBOX_DATA["messages"])
        
        if current_index < len(messages) - 1:
            await navigate_message(callback, state, current_index + 1)
        else:
            await show_inbox_menu(callback, state)
    
    async def cancel_junior_assignment(callback: CallbackQuery, state: FSMContext, message_id: str):
        """Cancel junior manager assignment"""
        
        data = await state.get_data()
        current_index = data.get("current_index", 0)
        await navigate_message(callback, state, current_index)
    
    async def show_message_detail(callback: CallbackQuery, state: FSMContext, message_id: str):
        """Show detailed message information"""
        
        data = await state.get_data()
        lang = data.get("language", "uz")
        
        # Find message
        message = None
        for msg in MOCK_INBOX_DATA["messages"]:
            if msg["id"] == message_id:
                message = msg
                break
        
        if not message:
            await callback.answer("Xabar topilmadi!" if lang == "uz" else "–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ!")
            return
        
        if lang == "uz":
            text = f"""
üìä <b>BATAFSIL MA'LUMOT</b>

üÜî Ariza ID: #{message['id']}
üìå Turi: {message['type']}
üë§ Mijoz: {message['from']}
üì± Telefon: {message['phone']}
üìç Manzil: {message['address']}
üí∞ Tarif: {message['tariff']}

‚è∞ Yaratilgan: {message['time'].strftime('%Y-%m-%d %H:%M')}
{get_priority_emoji(message['priority'])} Muhimlik: {message['priority']}
{get_status_emoji(message['status'])} Status: {message['status']}

üìù <b>To'liq xabar:</b>
{message['message']}

üìà <b>Tarix:</b>
‚Ä¢ Yaratilgan: {message['time'].strftime('%H:%M')}
‚Ä¢ Ko'rilgan: {datetime.now().strftime('%H:%M')}
            """
        else:
            text = f"""
üìä <b>–ü–û–î–†–û–ë–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø</b>

üÜî ID –∑–∞—è–≤–∫–∏: #{message['id']}
üìå –¢–∏–ø: {message['type']}
üë§ –ö–ª–∏–µ–Ω—Ç: {message['from']}
üì± –¢–µ–ª–µ—Ñ–æ–Ω: {message['phone']}
üìç –ê–¥—Ä–µ—Å: {message['address']}
üí∞ –¢–∞—Ä–∏—Ñ: {message['tariff']}

‚è∞ –°–æ–∑–¥–∞–Ω–æ: {message['time'].strftime('%Y-%m-%d %H:%M')}
{get_priority_emoji(message['priority'])} –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: {message['priority']}
{get_status_emoji(message['status'])} –°—Ç–∞—Ç—É—Å: {message['status']}

üìù <b>–ü–æ–ª–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:</b>
{message['message']}

üìà <b>–ò—Å—Ç–æ—Ä–∏—è:</b>
‚Ä¢ –°–æ–∑–¥–∞–Ω–æ: {message['time'].strftime('%H:%M')}
‚Ä¢ –ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ: {datetime.now().strftime('%H:%M')}
            """
        
        keyboard = InlineKeyboardMarkup(inline_keyboard=[
            [
                InlineKeyboardButton(
                    text="‚¨ÖÔ∏è Orqaga" if lang == "uz" else "‚¨ÖÔ∏è –ù–∞–∑–∞–¥",
                    callback_data=f"inbox:back_to_message"
                )
            ]
        ])
        
        await callback.message.edit_text(
            text,
            reply_markup=keyboard,
            parse_mode="HTML"
        )
    
    async def show_inbox_statistics(callback: CallbackQuery, state: FSMContext):
        """Show inbox statistics"""
        
        data = await state.get_data()
        lang = data.get("language", "uz")
        stats = MOCK_INBOX_DATA["statistics"]
        
        if lang == "uz":
            text = f"""
üìä <b>INBOX STATISTIKASI</b>

üìà <b>Umumiy ko'rsatkichlar:</b>
‚îú üì¨ Jami: {stats['total']}
‚îú üÜï Yangi: {stats['unread']} ({stats['unread']*100//stats['total']}%)
‚îú üî¥ Shoshilinch: {stats['urgent']} ({stats['urgent']*100//stats['total']}%)
‚îú ‚è≥ Kutilmoqda: {stats['pending']} ({stats['pending']*100//stats['total']}%)
‚îú üîÑ Jarayonda: {stats['in_progress']} ({stats['in_progress']*100//stats['total']}%)
‚îî ‚úÖ Hal qilingan: {stats['resolved']} ({stats['resolved']*100//stats['total']}%)

üìä <b>Bugungi faollik:</b>
‚îú üì• Kelgan: 12
‚îú üì§ Javob berilgan: 8
‚îú ‚úÖ Yopilgan: 5
‚îî üë®‚Äçüíº Yuborilgan: 3

‚è∞ <b>O'rtacha vaqt:</b>
‚îú Javob berish: 15 daqiqa
‚îú Hal qilish: 2 soat
‚îî Yopish: 4 soat
            """
        else:
            text = f"""
üìä <b>–°–¢–ê–¢–ò–°–¢–ò–ö–ê –í–•–û–î–Ø–©–ò–•</b>

üìà <b>–û–±—â–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏:</b>
‚îú üì¨ –í—Å–µ–≥–æ: {stats['total']}
‚îú üÜï –ù–æ–≤—ã–µ: {stats['unread']} ({stats['unread']*100//stats['total']}%)
‚îú üî¥ –°—Ä–æ—á–Ω—ã–µ: {stats['urgent']} ({stats['urgent']*100//stats['total']}%)
‚îú ‚è≥ –í –æ–∂–∏–¥–∞–Ω–∏–∏: {stats['pending']} ({stats['pending']*100//stats['total']}%)
‚îú üîÑ –í –ø—Ä–æ—Ü–µ—Å—Å–µ: {stats['in_progress']} ({stats['in_progress']*100//stats['total']}%)
‚îî ‚úÖ –†–µ—à–µ–Ω–Ω—ã–µ: {stats['resolved']} ({stats['resolved']*100//stats['total']}%)

üìä <b>–°–µ–≥–æ–¥–Ω—è—à–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:</b>
‚îú üì• –ü–æ–ª—É—á–µ–Ω–æ: 12
‚îú üì§ –û—Ç–≤–µ—á–µ–Ω–æ: 8
‚îú ‚úÖ –ó–∞–∫—Ä—ã—Ç–æ: 5
‚îî üë®‚Äçüíº –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: 3

‚è∞ <b>–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è:</b>
‚îú –û—Ç–≤–µ—Ç: 15 –º–∏–Ω—É—Ç
‚îú –†–µ—à–µ–Ω–∏–µ: 2 —á–∞—Å–∞
‚îî –ó–∞–∫—Ä—ã—Ç–∏–µ: 4 —á–∞—Å–∞
            """
        
        keyboard = InlineKeyboardMarkup(inline_keyboard=[
            [
                InlineKeyboardButton(
                    text="üì§ Export" if lang == "uz" else "üì§ –≠–∫—Å–ø–æ—Ä—Ç",
                    callback_data="inbox:export_stats"
                )
            ],
            [
                InlineKeyboardButton(
                    text="‚¨ÖÔ∏è Orqaga" if lang == "uz" else "‚¨ÖÔ∏è –ù–∞–∑–∞–¥",
                    callback_data="inbox:back_to_list"
                )
            ]
        ])
        
        await callback.message.edit_text(
            text,
            reply_markup=keyboard,
            parse_mode="HTML"
        )
    
    async def show_search_menu(callback: CallbackQuery, state: FSMContext):
        """Show search menu"""
        
        data = await state.get_data()
        lang = data.get("language", "uz")
        
        if lang == "uz":
            text = """
üîç <b>XABAR QIDIRISH</b>

Qanday qidirmoqchisiz?
            """
            
            keyboard = InlineKeyboardMarkup(inline_keyboard=[
                [
                    InlineKeyboardButton(text="üÜî ID bo'yicha", callback_data="search:by_id"),
                    InlineKeyboardButton(text="üë§ Ism bo'yicha", callback_data="search:by_name")
                ],
                [
                    InlineKeyboardButton(text="üì± Telefon bo'yicha", callback_data="search:by_phone"),
                    InlineKeyboardButton(text="üìÖ Sana bo'yicha", callback_data="search:by_date")
                ],
                [
                    InlineKeyboardButton(text="‚¨ÖÔ∏è Orqaga", callback_data="inbox:back_to_list")
                ]
            ])
        else:
            text = """
üîç <b>–ü–û–ò–°–ö –°–û–û–ë–©–ï–ù–ò–ô</b>

–ö–∞–∫ –∏—Å–∫–∞—Ç—å?
            """
            
            keyboard = InlineKeyboardMarkup(inline_keyboard=[
                [
                    InlineKeyboardButton(text="üÜî –ü–æ ID", callback_data="search:by_id"),
                    InlineKeyboardButton(text="üë§ –ü–æ –∏–º–µ–Ω–∏", callback_data="search:by_name")
                ],
                [
                    InlineKeyboardButton(text="üì± –ü–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É", callback_data="search:by_phone"),
                    InlineKeyboardButton(text="üìÖ –ü–æ –¥–∞—Ç–µ", callback_data="search:by_date")
                ],
                [
                    InlineKeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="inbox:back_to_list")
                ]
            ])
        
        await callback.message.edit_text(
            text,
            reply_markup=keyboard,
            parse_mode="HTML"
        )
        
        await state.set_state(ManagerInboxStates.searching)
    
    async def start_reply_process(callback: CallbackQuery, state: FSMContext, message_id: str):
        """Start reply process"""
        
        data = await state.get_data()
        lang = data.get("language", "uz")
        
        if lang == "uz":
            text = f"""
üí¨ <b>XABARGA JAVOB BERISH</b>

Ariza ID: #{message_id}

Javobingizni yozing va yuboring:
            """
        else:
            text = f"""
üí¨ <b>–û–¢–í–ï–¢ –ù–ê –°–û–û–ë–©–ï–ù–ò–ï</b>

ID –∑–∞—è–≤–∫–∏: #{message_id}

–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ:
            """
        
        keyboard = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(
                text="‚ùå Bekor qilish" if lang == "uz" else "‚ùå –û—Ç–º–µ–Ω–∞",
                callback_data=f"inbox:cancel_reply:{message_id}"
            )]
        ])
        
        await callback.message.edit_text(
            text,
            reply_markup=keyboard,
            parse_mode="HTML"
        )
        
        await state.set_state(ManagerInboxStates.replying_message)
        await state.update_data(replying_to=message_id)
    
    async def resolve_message(callback: CallbackQuery, state: FSMContext, message_id: str):
        """Mark message as resolved"""
        
        data = await state.get_data()
        lang = data.get("language", "uz")
        
        # Update message status
        for msg in MOCK_INBOX_DATA["messages"]:
            if msg["id"] == message_id:
                msg["status"] = "resolved"
                break
        
        # Update statistics
        MOCK_INBOX_DATA["statistics"]["resolved"] += 1
        MOCK_INBOX_DATA["statistics"]["pending"] -= 1
        
        if lang == "uz":
            await callback.answer("‚úÖ Ariza hal qilindi!", show_alert=True)
        else:
            await callback.answer("‚úÖ –ó–∞—è–≤–∫–∞ —Ä–µ—à–µ–Ω–∞!", show_alert=True)
        
        # Navigate to next message
        current_index = data.get("current_index", 0)
        messages = data.get("current_messages", MOCK_INBOX_DATA["messages"])
        
        if current_index < len(messages) - 1:
            await navigate_message(callback, state, current_index + 1)
        else:
            await show_inbox_menu(callback, state)
    
    async def change_message_status(callback: CallbackQuery, state: FSMContext, message_id: str):
        """Change message status"""
        
        data = await state.get_data()
        lang = data.get("language", "uz")
        
        if lang == "uz":
            text = f"""
üîÑ <b>STATUS O'ZGARTIRISH</b>

Ariza #{message_id} uchun yangi statusni tanlang:
            """
            
            keyboard = InlineKeyboardMarkup(inline_keyboard=[
                [
                    InlineKeyboardButton(text="üÜï Yangi", callback_data=f"status:new:{message_id}"),
                    InlineKeyboardButton(text="‚è≥ Kutilmoqda", callback_data=f"status:pending:{message_id}")
                ],
                [
                    InlineKeyboardButton(text="üîÑ Jarayonda", callback_data=f"status:in_progress:{message_id}"),
                    InlineKeyboardButton(text="‚úÖ Hal qilingan", callback_data=f"status:resolved:{message_id}")
                ],
                [
                    InlineKeyboardButton(text="‚ùå Bekor qilish", callback_data=f"inbox:cancel_status:{message_id}")
                ]
            ])
        else:
            text = f"""
üîÑ <b>–ò–ó–ú–ï–ù–ï–ù–ò–ï –°–¢–ê–¢–£–°–ê</b>

–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å –¥–ª—è –∑–∞—è–≤–∫–∏ #{message_id}:
            """
            
            keyboard = InlineKeyboardMarkup(inline_keyboard=[
                [
                    InlineKeyboardButton(text="üÜï –ù–æ–≤—ã–π", callback_data=f"status:new:{message_id}"),
                    InlineKeyboardButton(text="‚è≥ –í –æ–∂–∏–¥–∞–Ω–∏–∏", callback_data=f"status:pending:{message_id}")
                ],
                [
                    InlineKeyboardButton(text="üîÑ –í –ø—Ä–æ—Ü–µ—Å—Å–µ", callback_data=f"status:in_progress:{message_id}"),
                    InlineKeyboardButton(text="‚úÖ –†–µ—à–µ–Ω–æ", callback_data=f"status:resolved:{message_id}")
                ],
                [
                    InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞", callback_data=f"inbox:cancel_status:{message_id}")
                ]
            ])
        
        await callback.message.edit_text(
            text,
            reply_markup=keyboard,
            parse_mode="HTML"
        )
    
    @router.message(ManagerInboxStates.replying_message)
    async def process_reply(message: Message, state: FSMContext):
        """Process reply message"""
        
        data = await state.get_data()
        lang = data.get("language", "uz")
        message_id = data.get("replying_to")
        
        if lang == "uz":
            text = f"""
‚úÖ <b>JAVOB YUBORILDI!</b>

Ariza ID: #{message_id}
Javob: {message.text}
Vaqt: {datetime.now().strftime('%H:%M')}

Mijoz tez orada javobingizni oladi.
            """
        else:
            text = f"""
‚úÖ <b>–û–¢–í–ï–¢ –û–¢–ü–†–ê–í–õ–ï–ù!</b>

ID –∑–∞—è–≤–∫–∏: #{message_id}
–û—Ç–≤–µ—Ç: {message.text}
–í—Ä–µ–º—è: {datetime.now().strftime('%H:%M')}

–ö–ª–∏–µ–Ω—Ç —Å–∫–æ—Ä–æ –ø–æ–ª—É—á–∏—Ç –≤–∞—à –æ—Ç–≤–µ—Ç.
            """
        
        keyboard = InlineKeyboardMarkup(inline_keyboard=[
            [
                InlineKeyboardButton(
                    text="üì• Inbox'ga qaytish" if lang == "uz" else "üì• –í–µ—Ä–Ω—É—Ç—å—Å—è –≤–æ –≤—Ö–æ–¥—è—â–∏–µ",
                    callback_data="manager:inbox"
                )
            ],
            [
                InlineKeyboardButton(
                    text="üè† Asosiy menyu" if lang == "uz" else "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
                    callback_data="manager:back_to_menu"
                )
            ]
        ])
        
        await message.answer(
            text,
            reply_markup=keyboard,
            parse_mode="HTML"
        )
        
        await state.set_state(ManagerInboxStates.inbox_menu)
    
    return router
